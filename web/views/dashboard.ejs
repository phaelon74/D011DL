<%- include('partials/header') %>

<div class="container">
    <h1>Dashboard</h1>
    <a href="/logout">Logout</a>

    <h2>Download Hugging Face Model</h2>
    <form action="/start-download" method="POST">
        <input type="text" name="authorRepo" placeholder="e.g., TheDrummer/Behemoth-X-123B-v2" required style="width: 300px;">
        <button type="submit">Download</button>
    </form>
    <div id="parsed-result"></div>
    <div id="tree-container"></div>

    <h2>Tracked Models</h2>
    <table>
        <thead>
            <tr>
                <th>Author</th>
                <th>Repo</th>
                <th>Revision</th>
                <th>Status / Progress</th>
                <th>Location(s)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <% models.forEach(model => { %>
                <% const shouldDisplay = (model.locations && model.locations.length > 0) || (model.is_downloaded && (!model.locations || model.locations.length === 0)) || model.download_id; %>
                <% if (shouldDisplay) { %>
                    <tr>
                        <td><%= model.author %></td>
                        <td><%= model.repo %></td>
                        <td><%= model.revision %></td>
                        <td class="status-cell">
                            <% const job_status = model.job_status; %>
                            <% const job_type = model.job_type; %>
                            <% const download_status = model.download_status; %>

                            <% if ((job_status === 'running' || job_status === 'queued')) { %>
                                <div class="status-running">
                                    <strong>
                                        <% if (job_type === 'download') { %> Downloading... <% } %>
                                        <% if (job_type === 'copy') { %> Copying... <% } %>
                                        <% if (job_type === 'move') { %> Moving... <% } %>
                                    </strong>
                                </div>
                                <% if (job_type === 'download' && model.total_bytes > 0) { %>
                                    <progress value="<%= model.bytes_downloaded %>" max="<%= model.total_bytes %>"></progress>
                                    <div class="progress-text">
                                        <%= (model.bytes_downloaded / 1024 / 1024).toFixed(2) %> MB / 
                                        <%= (model.total_bytes / 1024 / 1024).toFixed(2) %> MB
                                    </div>
                                <% } %>
                            <% } else if (job_status === 'failed') { %>
                                <div class="status-failed" title="Error: <%= model.job_log || 'Unknown error' %>">
                                    failed
                                </div>
                            <% } else if (model.is_downloaded || (model.locations && model.locations.length > 0)) { %>
                                <div class="status-succeeded">succeeded</div>
                            <% } %>
                        </td>
                        <td>
                            <% if (model.locations && model.locations.length > 0) { %>
                                <%= model.locations.join(', ') %>
                            <% } %>
                        </td>
                        <td>
                            <% const isJobActive = job_status === 'running' || job_status === 'queued'; %>

                            <% if (job_status === 'failed') { %>
                                <form method="POST" style="display: inline;">
                                    <button type="submit" formaction="/retry-download/<%= model.download_id %>">Retry</button>
                                </form>
                            <% } %>

                            <% if ((model.is_downloaded || (model.locations && model.locations.length > 0))) { %>
                                <form method="POST" style="display: inline;">
                                    <button type="submit" formaction="/copy-model/<%= model.id %>" <%= isJobActive ? 'disabled' : '' %>>Copy</button>
                                    <button type="submit" formaction="/move-model/<%= model.id %>" <%= isJobActive ? 'disabled' : '' %>>Move</button>
                                    <button type="button" onclick="window.location.href='/delete-model/<%= model.id %>'" <%= isJobActive ? 'disabled' : '' %>>Delete</button>
                                    <button type="submit" formaction="/models/<%= model.id %>/rescan" <%= isJobActive ? 'disabled' : '' %>>Rescan</button>
                                </form>
                            <% } %>
                        </td>
                    </tr>
                <% } %>
            <% }) %>
        </tbody>
    </table>
</div>

<div class="refresh-container">
    <label for="refreshInterval">Auto-refresh:</label>
    <select id="refreshInterval">
        <option value="0" selected>Off</option>
        <option value="5">5s</option>
        <option value="10">10s</option>
        <option value="15">15s</option>
        <option value="30">30s</option>
        <option value="60">60s</option>
    </select>
    <span id="refreshTimer"></span>
</div>

<%- include('partials/footer') %>
